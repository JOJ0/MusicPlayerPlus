#!/bin/bash
#
# mpcinit - initialize mpcplus configuration files
#
# Copy and configure default configuration files in $HOME/.config/mpcplus/
# Also setup default tmux configuration for this user
# Install required pip modules if not already installed

CONFDIR=/usr/share/doc/musicplayerplus/mpcplus
WITHART="album_cover.sh catalog.conf config-cava \
         cover_obs.sh default_cover.png plasma.py julia.py"

[ -f ${CONFDIR}/config ] || {
    echo "${CONFDIR}/config does not exist."
    echo "MusicPlayerPlus installation incomplete"
    exit 1
}
[ -f ${CONFDIR}/bindings ] || {
    echo "${CONFDIR}/bindings does not exist."
    echo "MusicPlayerPlus installation incomplete"
    exit 1
}

if [ -f ${HOME}/.config/mpcplus/config ]
then
  MPCDIR=".config/mpcplus"
else
  if [ -f ${HOME}/.mpcplus/config ]
  then
    MPCDIR=".mpcplus"
  else
    [ -d ${HOME}/.config/mpcplus ] || mkdir -p ${HOME}/.config/mpcplus
    cp ${CONFDIR}/config ${HOME}/.config/mpcplus/config
    MPCDIR=".config/mpcplus"
  fi
fi
[ -f ${HOME}/${MPCDIR}/bindings ] || {
  cp ${CONFDIR}/bindings ${HOME}/${MPCDIR}/bindings
}

for cfg in ${WITHART}
do
  [ -f ${HOME}/${MPCDIR}/${cfg} ] || {
    cp ${CONFDIR}/${cfg} ${HOME}/${MPCDIR}/${cfg}
  }
done

[ -f /etc/mpd.conf ] || {
  echo "/etc/mpd.conf missing"
  echo "Check/reinstall mpd"
  exit 1
}

mpd_music=`grep ^music_directory /etc/mpd.conf`
[ "${mpd_music}" ] || mpd_music=`grep \#music_directory /etc/mpd.conf`
mpd_music=`echo ${mpd_music} | awk ' { print $2 } ' | sed -e "s/\"//g"`
[ "${mpd_music}" ] || {
  echo "Could not detect any music_directory setting in /etc/mpd.conf"
  echo "Manual configuration of /etc/mpd.conf and ${HOME}/${MPCDIR}/config required"
  exit 1
}

mpc_custom=1
mpc_music=`grep ^mpd_music_dir ${HOME}/${MPCDIR}/config`
[ "${mpc_music}" ] || {
  mpc_music=`grep \#mpd_music_dir ${HOME}/${MPCDIR}/config`
  mpc_custom=
}
mpc_music=`echo ${mpc_music} | awk ' { print $3 } '`
[ "${mpd_music}" == "${mpc_music}" ] || {
  if [ "${mpc_custom}" ]
  then
    cat ${HOME}/${MPCDIR}/config | sed -e "s%^mpd_music_dir.*%mpd_music_dir = ${mpd_music}%" > /tmp/newconf$$
  else
    cat ${HOME}/${MPCDIR}/config | sed -e "s%#mpd_music_dir.*%mpd_music_dir = ${mpd_music}%" > /tmp/newconf$$
  fi
  cp /tmp/newconf$$ ${HOME}/${MPCDIR}/config
  rm -f /tmp/newconf$$
  cat ${HOME}/${MPCDIR}/catalog.conf | sed -e "s%^mpd_music_dir.*%mpd_music_dir = ${mpd_music}%" > /tmp/catalog$$
  cp /tmp/catalog$$ ${HOME}/${MPCDIR}/catalog.conf
  rm -f /tmp/catalog$$
}

# Setup default tmux configuration for this user unless terminal-overrides has already been set
[ -f ${CONFDIR}/tmux.conf ] && {
  if [ -f ${HOME}/.tmux.conf ]
  then
    grep terminal-overrides ${HOME}/.tmux.conf > /dev/null || {
      cat ${CONFDIR}/tmux.conf >> ${HOME}/.tmux.conf
    }
  else
    cat ${CONFDIR}/tmux.conf >> ${HOME}/.tmux.conf
  fi
}

have_pip=`type -p pip`
[ "${have_pip}" ] || sudo apt install python3-pip
pip list | grep ueberzug > /dev/null || python -m pip install ueberzug
pip list | grep asciimatics > /dev/null || python -m pip install asciimatics
